
<style lang="scss">


    @font-face {font-family: "iconfont";
        src: url('data:application/x-font-woff;charset=utf-8;base64,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') format('truetype');
    }

    .iconfont {
        font-family:"iconfont" !important;
        font-size:16px;
        font-style:normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .icon-biaoqing:before { content: "\e646"; }

    .icon-iconfontzhizuobiaozhun0262:before { content: "\e6cc"; }


    page{
        background: #efefef;
    }
    .member_info_tab_view{
        padding-top: 90rpx;
        &_not{
            line-height: 240rpx;
            text-align: center;
            font-size: 36rpx;
        }
        &_item{
            padding: 0 20rpx;
            margin: 0 20rpx;
            background: #fff;
            border-top: 15rpx solid #efefef;
        }
        &_top,
        &_price{
            display: flex;
            font-size: 28rpx;
            justify-content: space-between;
        }
        &_top{
            line-height: 80rpx;
            .bianhao{
                color: #333333;
                font-size: 24rxp;
                line-height: 70rpx;
            }
            .jieguo{
                color: #333333;
                font-size: 24rxp;
            }
        }
        &_cont{
            display: flex;
            flex-wrap: wrap;
            &_img_wrap{
                width: 27.33%;
                flex-shrink: 0;
                margin-bottom: 12rpx;
                view{
                    width: 150rpx;
                    height: 150rpx;
                    background: {
                        size: cover;
                        position: center;
                    }
                }

            }
            &_img_wrapa{
                width: 70%;
                color: #666666;
                font-size: 24rpx;
                view{
                    padding-top: 22rpx;
                    color: #999999;
                    font-size: 22rpx;
                }
                .price{
                    font-size: 28rpx;
                    color: #f95353;
                    text-align: right;
                    padding-top: 22rpx;
                    text{
                        color: #999999;

                    }

                }
            }
        }
        &_price{
            padding: 20rpx 0;
            .zongjia{
                line-height: 56rpx;
                font-size: 36rpx;
            }
            .btns{

                .btnsid{
                    width: 130rpx;
                    height: 56rpx;
                    line-height: 56rpx;
                    text-align: center;
                    background: #f95353;
                    color: #fff;
                    font-size: 30rpx;
                    border-radius: 12rpx;
                    float: left;
                }
                .btnsqu{
                    width: 130rpx;
                    height: 56rxp;
                    line-height: 56rpx;
                    font-size: 30rpx;
                    text-align: center;
                    color: #999999;
                    float: left;
                    margin-left: 20rpx;
                }
            }
        }

    }
    .member_info_top{
        width: 100%;
        height: 90rpx;
        background-color: #fff;
        position: fixed;
        left: 0;top: 0;
        background: #f8f8f8;
        z-index: 99;
    }
    .icon_size{
        font-size: 188rpx;
    }
</style>

<template>
    <view class="member_info_wrap">
        <view class="member_info_top">
            <tab-switch :switchConfig.sync="switchConfig" :currentIndex.sync="current" @changeCurrent.user="changeCurrent"></tab-switch>
        </view>

        <view class="member_info_tab_view_not" wx:if="{{tabViewStatus}}">

            <abnor type="DATA"></abnor>

        </view>

        <scroll-view class="member_info_tab_view"
                     scroll-y="{{true}}"
                     style="height: {{scrollViewHeight}}px;"
                     scroll-top="{{scrollTop}}"
                     @scrolltolower="scrollTolowerHander" wx:if="{{!tabViewStatus}}" >
            <repeat for="{{tabView}}">

                <view class="member_info_tab_view_item" @tap="goTo" data-status="{{item.status}}" id="{{item.id}}">
                    <view class="member_info_tab_view_top">
                        <view class="bianhao">
                            订单编号:　{{item.id}}
                        </view>
                        <view class="jieguo">
                            {{item.status}}
                        </view>
                    </view>

                    <view class="member_info_tab_view_cont">
                        <repeat for="{{item.foods}}" item="foods">
                            <view class="member_info_tab_view_cont_img_wrap">
                                <view style="background-image: url({{foods.image}})"></view>
                            </view>
                            <view class="member_info_tab_view_cont_img_wrapa">{{foods.name}}

                                <view class="price">
                                    <text>共{{foods.quanty}}件商品</text>　￥{{foods.price}}
                                </view>

                            </view>
                        </repeat>
                    </view>

                    <view class="member_info_tab_view_price" >
                        <view class="zongjia">￥{{item.amount}}</view>
                        <view class="btns" catchtap="catch">
                            <view class="btnsid" id="{{item.btnId}}" wx:if="{{item.btnText}}" data-index="{{index}}" @tap="btnActive">
                                {{item.btnText}}
                            </view>
                            <view class="btnsqu" wx:if="{{item.cancelBtn}}" data-index="{{index}}" id="{{item.id}}" @tap="cancelOrder">取消订单</view>
                        </view>
                    </view>
                </view>

            </repeat>
        </scroll-view>
        <toast />
    </view>
</template>

<script>

    import wepy from 'wepy'
    import TabSwitch from '../components/TabSwitch'
    import getExtJson from '../mixins/getExtJson'
    import retainedDecimalMoney from '../mixins/retainedDecimalMoney'
    //    import Toast from 'wepy-com-toast'
    import Toast from 'xnr-toast'
    import payMethod from '../mixins/pay'
    import Abnor from 'xnr-abnor'

    export default class MemberInfo extends wepy.page{
        config = {
            navigationBarTitleText: '我的订单'
        }

        components = {
            'tab-switch': TabSwitch,
            toast: Toast,
            abnor: Abnor
        }
        methods = {
            catch(){},
            changeCurrent(index){
                wepy.showLoading({
                    title: '加载中...',
                    mask: true
                })
                this.scrollTop = 0
                setTimeout(() => {
                    this.scrollTop = ''
                }, 100)
                if(index != 4){
                    this.getTabViewData(index)
                }else{
                    this.getTabViewData()
                }
                this.current = index
                this.tabView = this.tabViewConfig[index]
                wepy.setNavigationBarTitle({
                    title: this.status[index]
                })
                this.currentPage = 1
                this.$apply()
            },
            btnActive(e){
                const id = e.currentTarget.id
                const index = e.currentTarget.dataset.index
                if(id == 0){
                    payMethod.call(this, {
                        data: {
                            id: this.tabView[index].id,
                            config_id: this.config_id,
                            openid: this.openid
                        }
                    })
                }
            },
            goTo(e){
                wepy.navigateTo({
                    url: `orderInfo?id=${e.currentTarget.id}&status=${e.currentTarget.dataset.status}`
                })
            },
            cancelOrder(e){
                wepy.showModal({
                    title: '提示',
                    content: '是否取消订单',
                    success: (res) => {
                        if(res.confirm){
                            wepy.showLoading({
                                title: '加载中...'
                            })
                            const id = e.currentTarget.id
                            const index = e.currentTarget.dataset.index
                            wepy.request({
                                url: `${this.api_host}/restapi/food-orders/${id}`,
                                data: {
                                    config_id: this.config_id,
                                    openid: this.openid
                                },
                                method: 'PUT',
                                success: (res) => {
                                    wepy.hideLoading()
                                    this.$invoke("toast", "show", {
                                        title: res.data.data.status,
                                        imgClassName: "iconfont icon-iconfontzhizuobiaozhun0262 icon_size"
                                    })
                                    this.tabView.splice(index, 1)
                                    this.$apply()
                                }
                            })
                        }
                    }
                })

            },
            /*
        * 用户下拉触底事件a
        * */
            scrollTolowerHander() {
                if(this.currentPage < this.pageCount) {
                    this.currentPage ++
                    wepy.request({
                        url: `${this.api_host}/restapi/food-orders`,
                        data: {
                            config_id: this.config_id,
                            'per-page': this.pageSize,
                            page: this.currentPage,
                            filter:[
                                {
                                    status: this.current != 4 ? this.status[this.current] : ''
                                },
                                {
                                    openid: this.openid
                                }
                            ]
                        },
                        success: (res) => {
                            res.data.data.items.forEach((item) => {
                                this.tabView.push(item)
                            })
                            this.$apply()
                        }
                    })
                }
            }
        }
        data = {
            current: 0,
            switchConfig: [
                {
                    name: '未支付',
                },
                {
                    name: '待配送',
                },
                {
                    name: '待收货',
                },
                {
                    name: '已完成',
                },
                {
                    name: '全部订单',
                },
            ],
            tabViewConfig: [],
            tabView: [],
            tabViewStatus: true,
            status: [
                '未支付',
                '待配送',
                '待收货',
                '已完成',
                '全部订单',
            ],
            scrollTop: '',
            pageSize: 20,
            scrollViewHeight: '0',
            pageCount: '',  //总页数
            currentPage: 1   //当前页数
        }
        getTabViewData(index){
            let data = {}
            if(index){
                const status = this.status[index]
                data = {
                    config_id: this.config_id,
                    'per-page': this.pageSize,
                    page: 1,
                    filter:[
                        {
                            status: status
                        },
                        {
                            openid: this.openid
                        }
                    ]
                }
            }else{
                data = {
                    config_id: this.config_id,
                    'per-page': this.pageSize,
                    page: 1,
                    filter:[
                        {
                            openid: this.openid
                        }
                    ]
                }
            }

            wepy.request({
                url: `${this.api_host}/restapi/food-orders`,
                data: data,
                success: (res) => {
                    this.pageCount = res.data.data._meta.pageCount
                    let inx = index || 4
                    let data = res.data.data.items
                    this.tabViewConfig[inx] = this.addBtnText(data)
                    this.tabView = this.addBtnText(data)
                    this.tabViewStatus = this.tabView.length > 0 ? false : true
                    this.$apply()
                    wepy.hideLoading()
                }
            })
        }
        addBtnText(data){
            data.forEach( item => {
                if(item.status == '未支付'){
                    item.btnText = '付款'
                    item.btnId = 0,
                        item.cancelBtn = true
                }else if(item.status == '待配送'){
                    item.btnText = ''
                    item.btnId = 1
                    item.cancelBtn = false
                }else if(item.status == '待收货'){
                    item.btnText = ''
                    item.btnId = 2
                    item.cancelBtn = false
                }else if(item.status == '已完成'){
                    item.btnText = ''
                    item.btnId = 3
                    item.cancelBtn = false
                }
            })
            return data
        }


        onShow(){
            if(this.current != 4){
                this.getTabViewData(this.current)
            }else{
                this.getTabViewData()
            }
        }
        onShareAppMessage() {

        }
        onLoad(option){
            this.current = option.index
            this.tabView = this.tabViewConfig[option.index]
            getExtJson.call(this)
            wepy.setNavigationBarTitle({
                title: this.status[option.index]
            })
            wepy.showLoading({
                title: '加载中...',
                mask: true
            })
            wx.createSelectorQuery().selectViewport('page').boundingClientRect((rect) => {
                this.scrollViewHeight = rect.height
                this.$apply()
            }).exec()
        }
    }

</script>


